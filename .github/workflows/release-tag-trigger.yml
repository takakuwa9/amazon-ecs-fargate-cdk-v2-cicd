name: Release Tag Trigger

on:
  push:
    tags:
      - 'release*'  # release ã§å§‹ã¾ã‚‹ã™ã¹ã¦ã®ã‚¿ã‚°

jobs:
  trigger-codebuild:
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1  # æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
      
      - name: Get tag name
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Triggered by tag: $TAG_NAME"
      
      - name: Get CodeBuild project name
        id: project
        run: |
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å–å¾—ï¼ˆã‚¹ã‚¿ãƒƒã‚¯åã®ä¸€éƒ¨ã‚’å«ã‚€ï¼‰
          PROJECT_NAME=$(aws codebuild list-projects --query "projects[?contains(@, 'EcsCdkStack')]" --output text | head -n1)
          
          if [ -z "$PROJECT_NAME" ]; then
            echo "âŒ CodeBuild project not found"
            exit 1
          fi
          
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "Found CodeBuild project: $PROJECT_NAME"
      
      - name: Start CodeBuild
        run: |
          echo "Starting CodeBuild project: ${{ steps.project.outputs.project_name }}"
          echo "With tag: ${{ steps.tag.outputs.tag_name }}"
          
          BUILD_ID=$(aws codebuild start-build \
            --project-name "${{ steps.project.outputs.project_name }}" \
            --source-version "${{ steps.tag.outputs.tag_name }}" \
            --environment-variables-override \
              name=CODEBUILD_WEBHOOK_TRIGGER,value=tag/${{ steps.tag.outputs.tag_name }},type=PLAINTEXT \
            --query 'build.id' \
            --output text)
          
          echo "âœ… CodeBuild started successfully!"
          echo "Build ID: $BUILD_ID"
          echo "You can monitor the build at:"
          echo "https://ap-northeast-1.console.aws.amazon.com/codesuite/codebuild/projects/${{ steps.project.outputs.project_name }}/build/$BUILD_ID"
      
      - name: Summary
        run: |
          echo "## ðŸš€ Release Tag Deployment Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.tag.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**CodeBuild Project:** \`${{ steps.project.outputs.project_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor the CodeBuild execution in AWS Console" >> $GITHUB_STEP_SUMMARY
          echo "2. Approve the deployment in CodePipeline" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify the deployment on ECS Fargate" >> $GITHUB_STEP_SUMMARY
