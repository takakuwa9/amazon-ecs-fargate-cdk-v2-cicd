name: Release Tag Trigger

on:
  push:
    tags:
      - 'release*'  # release ã§å§‹ã¾ã‚‹ã™ã¹ã¦ã®ã‚¿ã‚°

jobs:
  trigger-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1  # æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
      
      - name: Get tag name
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Triggered by tag: $TAG_NAME"
      
      - name: Start CodePipeline
        run: |
          echo "Starting CodePipeline: EcsCdkStack-myecspipeline0F854920-HnGkJ927SuEH"
          echo "With tag: ${{ steps.tag.outputs.tag_name }}"
          
          EXECUTION_ID=$(aws codepipeline start-pipeline-execution \
            --name EcsCdkStack-myecspipeline0F854920-HnGkJ927SuEH \
            --region ap-northeast-1 \
            --query 'pipelineExecutionId' \
            --output text)
          
          echo "âœ… CodePipeline started successfully!"
          echo "Execution ID: $EXECUTION_ID"
          echo "You can monitor the pipeline at:"
          echo "https://ap-northeast-1.console.aws.amazon.com/codesuite/codepipeline/pipelines/EcsCdkStack-myecspipeline0F854920-HnGkJ927SuEH/executions"
      
      - name: Summary
        run: |
          echo "## ðŸš€ Release Tag Deployment Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.tag.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline:** \`EcsCdkStack-myecspipeline0F854920-HnGkJ927SuEH\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor the CodePipeline execution in AWS Console" >> $GITHUB_STEP_SUMMARY
          echo "2. Approve the deployment when prompted" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify the deployment on ECS Fargate" >> $GITHUB_STEP_SUMMARY